#!/bin/zsh
# Run seq.  First make sure it's built and logview is running.

set -eu

if [[ -z $mode ]]; then
    echo $0: no mode
    exit 1
fi
if ! repl=t bin/mk build/$mode/logview build/$mode/seq; then
    echo $0: build failed
    exit 1
fi

# Keep the cache dir from getting too big.
tools/im-gc.py

# TODO This is hardcoded for my system, but should be in some local config.
if [[ $OSTYPE = linux-gnu ]]; then
    geometry='--geometry=628x300+1290+900'
else
    geometry=
fi

mkdir -p log

# Get rid of OS X window restore state.  It doesn't actually work, but it makes
# an annoying "restore state?" dialog on startup after a crash.
dir=~/Library/Saved\ Application\ State
rm -rf $dir/elaforge.seq.{seq,logview,browser}.savedState

build/$mode/logview $geometry &

if [[ -e seq-repl ]]; then
    echo "$0: seq-repl exists, is a copy already running?"
    exit 1
fi
build/$mode/seq "$@"
if [[ $? -ne 0 ]]; then
    rm seq-repl
fi

