#!/bin/zsh

prefixes=("$@")

run_profile=build/profile/RunProfile
out=prof

mkdir -p $out

flags=(
    # time profiling
    -s # emit runtime summary
    -p # emit .prof file

    # heap profiling
    -L42 # field length for cost center names in heap profile
    # -hc # by producing cost-center stack
    -hm # by module
    # -hd # by closure description
    # -hy # by type
    # -hr # by retainer set
    # -hb # by biography
)

profiles=($($run_profile --list $prefixes))

for prof in $profiles; do
    dir=$out/$(date +%y-%m-%d)/${prof/*.profile_/}
    mkdir -p $dir
    time $run_profile +RTS $flags -RTS $prof | tee $dir/stdout

    stem=$(basename $run_profile)
    mv $stem.prof $dir
    mv $stem.hp $dir
    mv $stem.aux $dir
    if [[ -e $dir/$stem.hp ]]; then
        hp2ps -c <$dir/$stem.hp >$dir/$stem.ps
    fi
done
